<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I Miei Ordini - Fast Food</title>
    <link rel="stylesheet" href="css/Header.css">
    <link rel="stylesheet" href="css/mainStyle.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background: #faf9d2;
            padding-top: 100px;
            margin: 0;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
        }

        .order-card {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            border-left: 5px solid #7ed991;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .status {
            font-weight: bold;
            color: #e67e22;
            text-transform: uppercase;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .date {
            color: #888;
            font-size: 0.9rem;
        }

        .total {
            float: right;
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .btn-dettagli {
            background: #ffcc00;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Montserrat', sans-serif;
            margin-top: 10px;
            transition: opacity 0.2s;
        }

            .btn-dettagli:hover {
                opacity: 0.8;
            }

        #view-dettaglio {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .back-btn {
            background: none;
            border: none;
            color: #e67e22;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            margin-bottom: 20px;
            padding: 0;
            font-size: 1rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .status-msg {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error-text {
            color: #e74c3c;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="header-placeholder"></div>

    <div class="container">
        <!-- VISTA LISTA -->
        <div id="view-lista">
            <h1>Storico Acquisti</h1>
            <div id="orders-list">
                <p class="status-msg">Caricamento in corso...</p>
            </div>
        </div>

        <!-- VISTA DETTAGLIO -->
        <div id="view-dettaglio">
            <button class="back-btn" onclick="mostraLista()">&larr; Torna allo storico</button>
            <h2 id="det-titolo">Dettaglio Ordine</h2>
            <div style="margin-bottom: 20px;">
                <div class="date">Effettuato il: <span id="det-data"></span></div>
                <div class="status">Stato: <span id="det-stato"></span></div>
            </div>
            <div id="det-prodotti"></div>
            <div style="margin-top: 30px; border-top: 2px solid #faf9d2; padding-top: 20px; text-align: right;">
                <span style="font-size: 1.1rem;">Totale Pagato:</span>
                <span id="det-totale" style="font-size: 1.5rem; font-weight: bold; margin-left: 10px;"></span>
            </div>
        </div>
    </div>

    <!-- Script API e Header -->
    <script src="js/api.js"></script>
    <script src="js/HeaderFunctions.js"></script>

    <script>
        let userOrders = [];

        document.addEventListener('DOMContentLoaded', async () => {
            // Inizializza Header (sempre visibile)
            if (typeof setupHeader === 'function') setupHeader();

            // 1. Verifica SEMPLICE della sessione
            // Nota: API.js di solito gestisce il token internamente, ma controlliamo per sicurezza
            const isLogged = window.API.isLoggedIn();

            if (!isLogged) {
                document.getElementById('orders-list').innerHTML = `
                            <div class="status-msg">
                                <p>Devi aver effettuato l'accesso per vedere i tuoi ordini.</p>
                                <button class="btn-dettagli" onclick="window.location.href='LogIn.html'">Vai al LogIn</button>
                            </div>`;
                return;
            }

            // 2. Carica gli ordini
            caricaOrdini();
        });

        async function caricaOrdini() {
            const listDiv = document.getElementById('orders-list');
            try {
                // Utilizziamo getOrders() del tuo api.js
                // Se il backend risponde con errore, il catch gestirà la visualizzazione
                // getOrders() nell'api.js (basato su conversazioni precedenti) dovrebbe chiamare /api/orders o /api/orders/user/:id
                const response = await window.API.getOrders();

                // Verifichiamo che la risposta sia un array
                userOrders = Array.isArray(response) ? response : [];

                if (userOrders.length === 0) {
                    listDiv.innerHTML = '<p class="status-msg">Non hai ancora effettuato ordini.</p>';
                    return;
                }

                // Ordina i più recenti in alto (usando createdAt o creationDate in base al modello)
                userOrders.sort((a, b) => {
                    const dateA = new Date(a.createdAt || a.creationDate || 0);
                    const dateB = new Date(b.createdAt || b.creationDate || 0);
                    return dateB - dateA;
                });

                listDiv.innerHTML = userOrders.map(o => {
                    const dateObj = new Date(o.createdAt || o.creationDate);
                    const dateStr = dateObj.toLocaleDateString('it-IT');
                    // Gestione compatibilità campi (totalAmount vs amount vs totale)
                    const totale = parseFloat(o.totalAmount || o.amount || o.totale || 0).toFixed(2);

                    return `
                            <div class="order-card">
                                <div class="total">€ ${totale}</div>
                                <div class="status">${o.status || 'In elaborazione'}</div>
                                <div class="date">Ordine #${o._id ? o._id.slice(-6) : 'N/D'} • ${dateStr}</div>
                                <button class="btn-dettagli" onclick="mostraDettaglio('${o._id}')">Vedi Dettagli</button>
                            </div>
                        `;
                }).join('');

            } catch (err) {
                console.error("Dettaglio Errore:", err);
                let messaggio = "Si è verificato un errore nel recupero degli ordini.";

                if (err.message === '401' || (err.response && err.response.status === 401)) {
                    messaggio = "La sessione è scaduta. Per favore, effettua di nuovo il login.";
                }

                listDiv.innerHTML = `
                            <div class="status-msg error-text">
                                <p>${messaggio}</p>
                                <small style="color: #999;">Dettaglio: ${err.message}</small>
                            </div>`;
            }
        }

        function mostraDettaglio(id) {
            const o = userOrders.find(x => x._id === id);
            if (!o) return;

            const dateObj = new Date(o.createdAt || o.creationDate);
            const totale = parseFloat(o.totalAmount || o.amount || o.totale || 0).toFixed(2);

            document.getElementById('det-titolo').innerText = `Dettaglio Ordine #${o._id.slice(-6)}`;
            document.getElementById('det-data').innerText = dateObj.toLocaleString('it-IT');
            document.getElementById('det-stato').innerText = o.status || 'In elaborazione';
            document.getElementById('det-totale').innerText = `€ ${totale}`;

            // Mostriamo i prodotti (gestendo sia l'oggetto piatto che il nome semplice)
            // L'array prodotti può chiamarsi 'items', 'products' o 'piatti' a seconda del backend
            const prodotti = o.items || o.products || o.piatti || [];

            document.getElementById('det-prodotti').innerHTML = prodotti.map(i => {
                const nomePiatto = i.name || i.nome || (i.plate && i.plate.name) || "Piatto non disponibile";
                const prezzoPiatto = parseFloat(i.price || i.prezzoUnitario || (i.plate && i.plate.price) || 0);
                const quantita = i.quantity || i.quantita || 1;

                return `
                            <div class="detail-row">
                                <span><strong>${quantita}x</strong> ${nomePiatto}</span>
                                <span>€ ${(prezzoPiatto * quantita).toFixed(2)}</span>
                            </div>
                        `;
            }).join('');

            document.getElementById('view-lista').style.display = 'none';
            document.getElementById('view-dettaglio').style.display = 'block';
            window.scrollTo(0, 0);
        }

        function mostraLista() {
            document.getElementById('view-dettaglio').style.display = 'none';
            document.getElementById('view-lista').style.display = 'block';
        }
    </script>
</body>
</html>