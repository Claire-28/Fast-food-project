<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Ristorante</title>
    <style>
        body { font-family: sans-serif; display: flex; gap: 20px; padding: 20px; background-color: #f4f4f9; }
        .menu-section { flex: 2; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .cart-section { flex: 1; min-width: 300px; background-color: #fff8e1; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 20px; }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; margin-top: 20px; }
        .menu-item { border: 1px solid #ddd; padding: 15px; border-radius: 6px; }
        .menu-item img { width: 100%; height: 120px; object-fit: cover; border-radius: 4px; margin-bottom: 10px; }
        .btn-primary { background-color: orangered; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        .btn-cart-plus, .btn-cart-minus { margin-left: 5px; padding: 3px 8px; background-color: #ccc; border: none; cursor: pointer; }
        .cart-item-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px dotted #eee; }
        /* Checkout */
        #checkoutSection label, #checkoutSection input, #checkoutSection select { display: block; width: 100%; margin-bottom: 10px; padding: 8px; }
    </style>
</head>
<body>
    <div class="menu-section">
        <h1 id="restaurantTitle">Caricamento Ristorante...</h1>
        <div id="restaurantDetails"></div>
        <hr>
        <h2>Menu Disponibile</h2>
        <div id="menuContainer" class="menu-grid">
            <p>Caricamento menu...</p>
        </div>
    </div>

    <div class="cart-section">
        <h2>ðŸ›’ Il tuo Carrello</h2>
        <h3 id="cartRestaurantName">Carrello vuoto</h3>
        <div id="cartItems"></div>
        <hr>
        <p id="cartSubtotal">Totale parziale: 0.00â‚¬</p>
        
        <div id="checkoutSection" style="display:none;">
            <h3>Dettagli Ordine</h3>
            
            <label for="tipoConsegna">Tipo di Consegna:</label>
            <select id="tipoConsegna">
                <option value="Consegna a domicilio">Consegna a domicilio</option>
                <option value="Ritiro">Ritiro in sede</option>
            </select>
            
            <label for="deliveryAddress">Indirizzo di Consegna:</label>
            <input type="text" id="deliveryAddress" placeholder="Via/Piazza, Civico, CittÃ " required>

            <label for="costoConsegna">Costo Consegna (â‚¬):</label>
            <input type="number" id="costoConsegna" value="5.00" step="0.01" min="0" readonly> 
            
            <label for="paymentMethod">Metodo di Pagamento:</label>
            <select id="paymentMethod">
                <option value="Contanti">Contanti alla consegna</option>
                <option value="Carta">Carta di Credito</option>
            </select>

            <button id="checkoutButton" class="btn-primary" style="width: 100%; margin-top: 15px;">Completa Ordine</button>
        </div>
    </div>
    
    <script>
        const API_BASE_URL = 'http://127.0.0.1:3019/api';
        let CURRENT_RESTAURANT_ID = null;
        let RESTAURANT_DATA = {};
        const messageBox = document.getElementById('messageBox');

        //mostrare i messaggi
        function displayMessage(message, type) {
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            if (type === 'success') {
                messageBox.style.backgroundColor = '#d4edda';
                messageBox.style.color = '#155724';
                messageBox.style.border = '1px solid #c3e6cb';
            } else if (type === 'danger') {
                messageBox.style.backgroundColor = '#f8d7da';
                messageBox.style.color = '#721c24';
                messageBox.style.border = '1px solid #f5c6cb';
            } else {
                messageBox.style.backgroundColor = '#fff3cd';
                messageBox.style.color = '#856404';
                messageBox.style.border = '1px solid #ffeeba';
            }
            setTimeout(() => { messageBox.style.display = 'none'; }, 5000);
        }

        async function fetchData(endpoint, method = 'GET', body = null) {
            const token = localStorage.getItem('token');
            const headers = { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };

            const config = { method, headers };
            if (body) {
                config.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                const data = await response.json();

                if (response.status === 401) {
                    localStorage.removeItem('token');
                    displayMessage("Sessione scaduta o non autorizzata. Effettua nuovamente il login", 'danger');
                    window.location.href = 'LogIn.html';
                    return;
                }

                if (!response.ok) {
                    console.error(`Errore API ${endpoint}:`, data.error);
                    throw new Error(data.error || 'Errore nel recupero dati');
                }
                return data;
            } catch (error) {
                console.error('Errore durante la fetch: ', error);
                throw error; 
            }
        }
        
        // --- GESTIONE CARRELLO (LOCAL STORAGE) ---

        function getCart() {
            const cartJson = localStorage.getItem('cart');
            return cartJson ? JSON.parse(cartJson) : { items: [], restaurantId: null, restaurantName: null };
        }

        function saveCart(cart) {
            localStorage.setItem('cart', JSON.stringify(cart));
        }

        function addToCart(plateId, mealId, name, price) {
            let cart = getCart();

            if (cart.restaurantId && cart.restaurantId !== CURRENT_RESTAURANT_ID) {
                const isConfirmed = window.confirm(`Stai cercando di ordinare da un altro ristorante. Vuoi svuotare il carrello e continuare con ${RESTAURANT_DATA.nome}?`);
                if (!isConfirmed) {
                    return;
                }
                cart = { items: [], restaurantId: CURRENT_RESTAURANT_ID, restaurantName: RESTAURANT_DATA.nome };
            } else if (!cart.restaurantId) {
                cart.restaurantId = CURRENT_RESTAURANT_ID;
                cart.restaurantName = RESTAURANT_DATA.nome;
            }

            const existingItem = cart.items.find(item => item.plateId === plateId);

            if (existingItem) {
                existingItem.quantita += 1;
            } else {
                cart.items.push({
                    plateId,
                    mealId,
                    name,
                    price,
                    quantita: 1
                });
            }

            saveCart(cart);
            renderCart();
            displayMessage(`Aggiunto: ${name}`, 'success');
        }

        function updateCartQuantity(plateId, change) {
            let cart = getCart();
            const itemIndex = cart.items.findIndex(item => item.plateId === plateId);

            if (itemIndex > -1) {
                cart.items[itemIndex].quantita += change;

                if (cart.items[itemIndex].quantita <= 0) {
                    cart.items.splice(itemIndex, 1);
                }
            }
            
            if (cart.items.length === 0) {
                 cart.restaurantId = null;
                 cart.restaurantName = null;
            }

            saveCart(cart);
            renderCart();
        }
        
        // --- FUNZIONI DI RENDER (HTML) ---

        function renderMenu(menu) {
            const menuContainer = document.getElementById('menuContainer');
            menuContainer.innerHTML = '';
            
            if (menu.length === 0) {
                menuContainer.innerHTML = '<p>Questo ristorante non ha ancora pubblicato il menu.</p>';
                return;
            }

            menu.forEach(plate => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'menu-item';
                itemDiv.innerHTML = `
                    <img src="${plate.strMealThumb || 'placeholder.jpg'}" alt="${plate.strMeal}">
                    <h4>${plate.strMeal}</h4>
                    <p><strong>Prezzo:</strong> ${plate.prezzo}â‚¬</p>
                    <button onclick="addToCart(
                        '${plate._id}', 
                        '${plate.mealId}', 
                        '${plate.strMeal}', 
                        ${plate.prezzo}
                    )" class="btn-primary">Aggiungi al Carrello</button>
                `;
                menuContainer.appendChild(itemDiv);
            });
        }

        function renderCart() {
            const cartItemsDiv = document.getElementById('cartItems');
            const cart = getCart();

            const isDelivery = document.getElementById('tipoConsegna').value === 'Consegna a domicilio';
            
            const deliveryCostEl = document.getElementById('cartDeliveryCost');
            const totalFinalEl = document.getElementById('cartTotalFinal');

            if (!cart.restaurantId || cart.items.length === 0) {
                document.getElementById('cartRestaurantName').textContent = 'Carrello vuoto.';
                cartItemsDiv.innerHTML = '<p>Inizia ad aggiungere piatti al carrello.</p>';
                document.getElementById('checkoutSection').style.display = 'none';
                deliveryCostEl.style.display = 'none';
                totalFinalEl.textContent = 'Totale: 0.00â‚¬';
                return;
            }

            document.getElementById('cartRestaurantName').textContent = `Ordine da: ${cart.restaurantName}`;
            document.getElementById('checkoutSection').style.display = 'block';
            cartItemsDiv.innerHTML = '';

            let subtotal = 0;

            cart.items.forEach(item => {
                const itemTotal = item.price * item.quantita;
                subtotal += itemTotal;
                
                const itemRow = document.createElement('div');
                itemRow.className = 'cart-item-row';
                itemRow.innerHTML = `
                    <span>${item.name}</span>
                    <span style="min-width: 90px; text-align: center;">
                        <button onclick="updateCartQuantity('${item.plateId}', 1)" class="btn-cart-plus">+</button>
                        ${item.quantita}
                        <button onclick="updateCartQuantity('${item.plateId}', -1)" class="btn-cart-minus">-</button>
                    </span>
                    <strong>${(itemTotal).toFixed(2)}â‚¬</strong>
                `;
                cartItemsDiv.appendChild(itemRow);
            });

            document.getElementById('cartSubtotal').textContent = `Totale parziale: ${subtotal.toFixed(2)}â‚¬`;
        }

        // --- FUNZIONI DI INIZIALIZZAZIONE E CHECKOUT ---

        async function loadRestaurantMenu() {
            const urlParams = new URLSearchParams(window.location.search);
            const restaurantId = urlParams.get('id');

            if (!restaurantId) {
                displayMessage('ID Ristorante mancante. Tornare alla Ricerca Ristoranti.', 'danger');
                console.error('ID Ristorante mancante. Reindirizzo.');
                setTimeout(() => {
                    window.location.href = '/SearchRestaurants.html';
                }, 1500);
                return;
            }
            
            CURRENT_RESTAURANT_ID = restaurantId;

            try {
                // API GET /api/restaurants/:id/menu
                const data = await fetchData(`/restaurants/${restaurantId}/menu`); 
                
                RESTAURANT_DATA = data.restaurant;
                
                document.getElementById('restaurantTitle').textContent = data.restaurant.nome;
                document.getElementById('restaurantDetails').innerHTML = `
                    <p>Indirizzo: ${data.restaurant.indirizzo}</p>
                    <p>Telefono: ${data.restaurant.telefono}</p>
                `;
                
                renderMenu(data.menu);
                renderCart();

            } catch (e) {
                document.getElementById('restaurantTitle').textContent = 'Errore nel caricamento';
                document.getElementById('menuContainer').innerHTML = `<p style="color: red;">${e.message}</p>`;
            }
        }

        async function handleCheckout() {
            const cart = getCart();
            if (cart.items.length === 0) {
                displayMessage('Il carrello Ã¨ vuoto!', 'warning');
                return;
            }
            
            const deliveryAddress = document.getElementById('deliveryAddress').value;
            const tipoConsegna = document.getElementById('tipoConsegna').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            
            const isDelivery = tipoConsegna === 'Consegna a domicilio';
            const deliveryAddress = isDelivery ? deliveryAddressInput.value : 'Ritiro in sede';

            if (isDelivery && !deliveryAddress) {
                displayMessage('Compila l\'indirizzo di consegna per la consegna a domicilio.', 'warning');
                return;
            }

            if (isDelivery && !deliveryAddress) {
                displayMessage('Seleziona un metodo di pagamento.', 'warning');
                return;
            }

            if (!paymentMethod) {
                alert('Seleziona un mmetodo di pagamento');
                retun;
            }

            const orderItems = cart.items.map(item => ({
                mealId: item.mealId,
                quantita: item.quantita
            }));

            const orderData = {
                ristoranteId: cart.restaurantId,
                carrello: orderItems, // Mappa al campo piatti nello schema
                indirizzoConsegna: isDelivery ? deliveryAddress : 'Ritiro in sede',
                tipoConsegna: tipoConsegna,
                paymentMethod: paymentMethod 
            };

            const checkoutButton = document.getElementById('checkoutButton');
            checkoutButton.disabled = true;
            checkoutButton.textContent = 'Creazione Ordine...';
            messageBox.style.display = 'none';

            try {
                // API POST /api/orders
                const response = await fetchData('/orders', 'POST', orderData);

                if (response && response.ordineId) {
                    displayStatusMessage(`Ordine creato con successo! ID: #${response.ordineId.slice(-6)}. Totale: ${response.totale}â‚¬. Stato: ${response.stato}`, 'success');
                    localStorage.removeItem('cart');
                    renderCart();

                    // Ritorna alla lista ordini o alla ricerca dopo l'ordine
                    setTimeout(() => window.location.href = `/ClientOrders.html`, 1500);
                }
            } catch (e) {
                displayStatusMessage('Errore durante il checkout: ' + e.message, 'danger');
            } finally {
                checkoutButton.disabled = false;
                checkoutButton.textContent = 'Completa Ordine';
            }
        }

        // --- AVVIO ---

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/LogIn.html';
                return;
            }

            const tipoConsegnaInput = document.getElementById('tipoConsegna');
            const deliveryAddressGroup = document.getElementById('deliveryAddressGroup');
            const costoConsegnaGroup = document.getElementById('costoConsegnaGroup');
            const deliveryAddressInput = document.getElementById('deliveryAddress');

            tipoConsegnaInput.addEventListener('change', (e) => {
                const isDelivery = e.target.value === 'Consegna a domicilio';

                deliveryAddressGroup.style.display = isDelivery ? 'block' : 'none';
                deliveryAddressInput.required = isDelivery;

                // Mostra il campo costo consegna solo come indicazione se Ã¨ Consegna a domicilio
                costoConsegnaGroup.style.display = isDelivery ? 'block' : 'none';
                document.getElementById('costoConsegna').value = isDelivery ? '5.00' : '0.00';
            });

            tipoConsegnaInput.dispatchEvent(new Event('change'));

            loadRestaurantMenu();

            const checkoutButton = document.getElementById('checkoutButton');
            if (checkoutButton) {
                checkoutButton.addEventListener('click', handleCheckout);
            }
        });
    </script>
</body>
</html>