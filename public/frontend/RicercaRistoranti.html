<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EAT(W) - Ricerca Ristoranti</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      font-family: Arial, sans-serif;
    }

    nav {
      margin-bottom: 20px;
    }
    
    .intro-text {
      text-align: center;
      margin: 40px 0;
    }

    .restaurant-card {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      transition: transform  0.2s;
      cursor: pointer;
    }

    .restaurant-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container">
      <a class="navbar-brand" href="SearchRestaurants.html">EAT</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link active" href="SearchRestaurants.html" id="restaurantsLink">Ristoranti</a></li>
          <li class="nav-item"><a class="nav-link" href="Piatti.html">Catalogo Piatti</a></li>
          <li class="nav-item"><a class="nav-link" href="ClientOrders.html">Miei Ordini</a></li>
          <!-- I link di login/signup verranno aggiunti dinamicamente -->
        </ul>
      </div>
    </div>
  </nav>

  <!-- Breve introduzione -->
  <div class="container mt-4">
      <div class="intro-text"> <h2>Benvenuto su EAT(W) - Eat Around The World</h2>
        <p>Inizia il tuo ordine cercando un ristorante per nome o luogo!</p>
      </div>

        <form id="search-form" class="row g-3 mb-4 justify-content-center">
            <div class="col-md-4">
                <input type="text" class="form-control" id="restaurant-name" placeholder="Nome del Ristorante (Opzionale)">
            </div>
            <div class="col-md-5">
                <input type="text" class="form-control" id="location-query" placeholder="CittÃ  o Indirizzo (Obbligatorio)" required>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Cerca</button>
            </div>
            <div id="search-message" class="col-md-11 alert alert-info d-none mt-2"></div>
        </form>

        <section id="search-results" class="row row-cols-1 row-cols-md-3 g-4">
            <div class="col">
                <p class="text-muted">Inserisci un luogo e premi cerca per trovare i ristoranti vicino a te.</p>
            </div>
        </section>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Sostituzione delle dipendenze dei moduli con la funzione fetchData
      
      const API_BASE_URL = 'http://127.0.0.1:3019/api';
      
      function showMessage(text, isSuccess) {
            const el = document.getElementById('search-message');
            el.textContent = text;
            el.className = `col-md-11 alert ${isSuccess ? 'alert-success' : 'alert-danger'} mt-2`;
            el.classList.remove('d-none');
            setTimeout(() => el.classList.add('d-none'), 5000);
        }

        async function fetchData(endpoint, method = 'GET', body = null) {
            const token = localStorage.getItem('token');
            const headers = { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };

            const config = { method, headers };
            if (body) {
                config.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                const data = await response.json();

                if (!response.ok) {
                    console.error(`Errore API ${endpoint}:`, data.error);
                    throw new Error(data.error || 'Errore nel recupero dati');
                }
                return data;
            } catch (error) {
                console.error('Errore durante la fetch: ', error);
                throw error; 
            }
        }
      
      // Funzione per la ricerca dei ristoranti
      const searchForm = document.getElementById('search-form');
      searchForm.addEventListener('submit', handleSearch);

      async function handleSearch(e) {
        e.preventDefault();
        
        const nome = document.getElementById('restaurant-name').value;
        const luogo = document.getElementById('location-query').value;
        const resultsContainer = document.getElementById('search-results');
        
        resultsContainer.innerHTML = '<div class="col"><p class="text-info">Ricerca in corso...</p></div>';

        const params = new URLSearchParams();
        if (nome) params.append('nome', nome);
        if (luogo) params.append('luogo', luogo);
        
        if (!nome && !luogo) {
            resultsContainer.innerHTML = '<div class="col"><p class="text-warning">Inserisci almeno un nome o un luogo per la ricerca.</p></div>';
            return;
        }

        try {
            const restaurants = await fetchData(`/restaurants/search?${params.toString()}`);
            
            resultsContainer.innerHTML = '';

            if (restaurants.length === 0) {
                resultsContainer.innerHTML = '<div class="col"><p class="text-muted">Nessun ristorante trovato con questi criteri.</p></div>';
                return;
            }

            restaurants.forEach(rest => {
                const card = document.createElement('div');
                card.className = 'col';
                card.innerHTML = `
                    <div class="restaurant-card" onclick="window.location.href='MenuCliente.html?id=${rest._id}'">
                        <h4>${rest.nome}</h4>
                        <p class="mb-1">${rest.indirizzo}</p>
                        <p class="text-muted small">Telefono: ${rest.telefono || 'N/D'}</p>
                        <button class="btn btn-sm btn-primary">Vedi Menu</button>
                    </div>
                `;
                resultsContainer.appendChild(card);
            });

        } catch (error) {
            resultsContainer.innerHTML = `<div class="col"><p class="text-danger">Errore nella ricerca: ${error.message}</p></div>`;
            console.error('Errore nella ricerca ristoranti:', error);
        }
      }
      
      // Funzione di setup iniziale (navbar)
      function setupNavbar() {
        const token = localStorage.getItem('token');
        const ruolo = localStorage.getItem('ruolo');
        const navbarNav = document.getElementById('navbarNav').querySelector('.ms-auto');
        
        navbarNav.innerHTML = '';

        if (token) {
            if (ruolo === 'Ristoratore') {
                navbarNav.innerHTML += '<li class="nav-item"><a class="nav-link" href="DashboardRistoratore.html">Dashboard Ristorante</a></li>';
            } else if (ruolo === 'Cliente') {
                navbarNav.innerHTML += `
                    <li class="nav-item"><a class="nav-link" href="Piatti.html">Catalogo Piatti</a></li>
                    <li class="nav-item"><a class="nav-link" href="ClientOrders.html">Miei Ordini</a></li>
                `;
            }

            // Link al Profilo e Log Out
            navbarNav.innerHTML += '<li class="nav-item"><a class="nav-link" href="Profile.html">Profilo</a></li>';
            navbarNav.innerHTML += '<li class="nav-item"><a class="nav-link" href="#" id="logoutBtn">Log Out</a></li>';

            document.getElementById('logoutBtn').addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('token');
                localStorage.removeItem('ruolo');
                window.location.href = '/LogIn.html';
            });
        } else {
            // Se non loggato, mostra Log In e Sign Up
            navbarNav.innerHTML += `
                <li class="nav-item"><a class="nav-link" href="LogIn.html">Log In</a></li>
                <li class="nav-item"><a class="nav-link" href="SignUp.html">Sign Up</a></li>
            `;
        }
      }
      
      document.addEventListener('DOMContentLoaded', setupNavbar);
    </script>
</body>
</html>