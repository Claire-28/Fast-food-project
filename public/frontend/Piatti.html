<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LemonLime - Catalogo Piatti</title>

    <link rel="stylesheet" href="css/Header.css">

    <!-- Stili inline per il layout -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&display=swap');

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #faf9d2;
            padding-top: 110px;
            margin: 0;
        }

        .catalog-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .filter-bar {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px;
            align-items: end;
            background: rgba(255,255,255,0.8);
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 30px;
        }

            .filter-bar .form-group {
                margin-bottom: 0;
            }

                .filter-bar .form-group label {
                    display: block;
                    font-weight: bold;
                    margin-bottom: 5px;
                    color: #2d3436;
                    font-size: 0.9rem;
                }

            .filter-bar input {
                width: 100%;
                padding: 12px;
                border-radius: 10px;
                border: 1px solid #ddd;
                box-sizing: border-box;
                font-family: inherit;
            }

            /* Griglia Layout Filtri */
            .filter-bar .form-group:nth-child(1), .filter-bar .form-group:nth-child(2) {
                grid-column: span 3;
            }

            .filter-bar .form-group:nth-child(3), .filter-bar .form-group:nth-child(4), .filter-bar .form-group:nth-child(5) {
                grid-column: span 2;
            }

        .btn-primary {
            background: linear-gradient(135deg, #fcf76d 0%, #7ed991 100%);
            border: none;
            color: #2d3436;
            font-weight: 800;
            cursor: pointer;
            width: 100%;
            border-radius: 10px;
            transition: 0.3s;
        }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }

        /* Griglia Piatti */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .meal-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            padding: 15px;
            border: 2px solid transparent;
            transition: 0.3s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

            .meal-card:hover {
                border-color: #96fbc4;
                transform: translateY(-5px);
            }

        .meal-info {
            padding: 10px 5px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        /* Stile pulsante carrello piccolo in alto */
        .btn-cart-mini {
            width: fit-content !important;
            padding: 4px 12px !important;
            font-size: 0.7rem !important;
            margin-bottom: 8px;
            align-self: flex-end;
        }

        /* Stile pulsante ristoranti in basso */
        .btn-find-bottom {
            margin-top: auto;
            background: white !important;
            border: 2px solid #eee !important;
            color: #2d3436 !important;
            font-weight: 600 !important;
            font-size: 0.85rem !important;
            padding: 10px !important;
        }

        /* Stile per sezione ristoratore */
        .ristoratore-actions {
            margin-top: auto;
            display: flex;
            gap: 10px;
            align-items: center;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        .message-box {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            display: none;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .filter-bar {
                grid-template-columns: 1fr;
            }

                .filter-bar .form-group:nth-child(n) {
                    grid-column: span 1;
                }
        }
    </style>
</head>
<body>

    <!-- Placeholder principale per l'header -->
    <div id="header-placeholder"></div>

    <div class="catalog-container">
        <h2 style="text-align:center; color:#2d3436; margin-bottom:10px;">Esplora i Sapori üçã</h2>
        <p style="text-align:center; margin-bottom:30px; color:#636e72;">Cerca tra i nostri ingredienti freschi</p>

        <!-- Barra Filtri -->
        <div class="filter-bar">
            <div class="form-group">
                <label>Cosa cerchi?</label>
                <input type="text" id="searchName" placeholder="Es. Pasta, Pizza...">
            </div>
            <div class="form-group">
                <label>Categoria</label>
                <input type="text" id="searchCategory" placeholder="Es. Dessert">
            </div>
            <div class="form-group">
                <label>Ingrediente</label>
                <input type="text" id="searchIng" placeholder="Es. Basilico">
            </div>
            <div class="form-group">
                <label>Escludi Allergeni</label>
                <input type="text" id="searchAllergen" placeholder="Es. Noci">
            </div>
            <div class="form-group">
                <button class="btn-primary" onclick="loadMeals()" style="height: 42px;">Cerca</button>
            </div>
        </div>

        <div id="messageBox" class="message-box"></div>

        <div id="mealsGrid" class="grid-container">
            <p style="text-align:center; grid-column: 1/-1;">Caricamento catalogo...</p>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="js/api.js"></script>
    <script src="js/HeaderFunctions.js"></script>
    <script src="js/cart.js"></script>

    <script>
        let currentUserRole = null;
        let allMeals = [];

        document.addEventListener('DOMContentLoaded', () => {
            // Inizializza l'header
            if (typeof initHeader === 'function') {
                initHeader();
            }

            if (!API.isLoggedIn()) {
                window.location.href = 'LogIn.html';
                return;
            }

            const user = API.getUser();
            currentUserRole = user ? user.role : 'cliente';

            loadMeals();
        });

        async function loadMeals() {
            const grid = document.getElementById('mealsGrid');
            const nameV = document.getElementById('searchName').value;
            const catV = document.getElementById('searchCategory').value;
            const ingV = document.getElementById('searchIng').value;
            const algV = document.getElementById('searchAllergen').value;

            const filters = {};
            if (nameV) filters.nome = nameV;
            if (catV) filters.tipologia = catV;
            if (ingV) filters.ingredienti = ingV;
            if (algV) filters.allergie = algV;

            grid.innerHTML = '<p style="text-align:center; width:100%; grid-column: 1/-1;">Spremendo i limoni... üçã</p>';

            try {
                allMeals = await API.getMeals(filters);

                if (!allMeals || allMeals.length === 0) {
                    grid.innerHTML = '<p style="text-align:center; width:100%; grid-column: 1/-1;">Nessun piatto trovato.</p>';
                    return;
                }

                grid.innerHTML = '';
                allMeals.forEach(meal => {
                    grid.appendChild(createMealCard(meal));
                });

            } catch (error) {
                console.error("Errore loadMeals:", error);
                grid.innerHTML = `<p style="color:red; text-align:center; grid-column: 1/-1;">Errore: ${error.message}</p>`;
            }
        }

        function createMealCard(meal) {
            const div = document.createElement('div');
            div.className = 'meal-card';

            // Reindirizzamento al dettaglio cliccando sulla card
            div.addEventListener('click', (e) => {
                if (e.target.closest('button') || e.target.closest('input')) return;
                window.location.href = `DettaglioPiatto.html?id=${meal.idMeal}`;
            });

            const imgUrl = meal.strMealThumb || 'https://via.placeholder.com/300x200?text=No+Image';

            let ingredientsList = 'N/D';
            if (meal.ingredients && Array.isArray(meal.ingredients)) {
                ingredientsList = meal.ingredients.slice(0, 3).join(', ') + (meal.ingredients.length > 3 ? '...' : '');
            }

            const mealInfo = document.createElement('div');
            mealInfo.className = 'meal-info';

            if (currentUserRole === 'ristoratore') {
                // Layout Ristoratore
                const catTag = document.createElement('div');
                catTag.style.marginBottom = "5px";
                catTag.innerHTML = `<span style="font-size:0.7rem; background:#eee; padding:2px 6px; border-radius:8px; color:#666;">${meal.strCategory}</span>`;

                const title = document.createElement('h3');
                title.style.cssText = "font-size:1.1rem; margin:0 0 10px 0; color:#2d3436;";
                title.textContent = meal.strMeal;

                const ingr = document.createElement('p');
                ingr.style.cssText = "font-size:0.85rem; color:#666; margin: 0 0 15px 0;";
                ingr.textContent = `Ingr: ${ingredientsList}`;

                const restActions = document.createElement('div');
                restActions.className = 'ristoratore-actions';
                restActions.innerHTML = `
                        <div style="display:flex; flex-direction:column; gap:2px;">
                            <label style="font-size:0.65rem; font-weight:bold;">Prezzo (‚Ç¨)</label>
                            <input type="number" id="price-${meal.idMeal}" value="10.00" min="0" step="0.5" style="width: 60px; padding:5px; border-radius:5px; border:1px solid #ddd;">
                        </div>
                        <button class="btn-primary btn-add-menu" style="font-size:0.8rem; padding: 10px;">Aggiungi al Men√π</button>
                    `;

                restActions.querySelector('.btn-add-menu').onclick = (e) => {
                    e.stopPropagation();
                    const price = document.getElementById(`price-${meal.idMeal}`).value;
                    alert(`Piatto "${meal.strMeal}" aggiunto al tuo men√π a ‚Ç¨${price}!`);
                };

                mealInfo.appendChild(catTag);
                mealInfo.appendChild(title);
                mealInfo.appendChild(ingr);
                mealInfo.appendChild(restActions);

            } else {
                // Layout Cliente: Pulsante carrello in ALTO (prima della categoria)
                const addBtn = document.createElement('button');
                addBtn.className = 'btn-primary btn-cart-mini';
                addBtn.innerHTML = 'Aggiungi üõí';

                addBtn.onclick = (e) => {
                    e.stopPropagation();

                    // Prepariamo l'oggetto come richiesto dalla funzione 'add' in cart.js
                    const productToCart = {
                        id: meal.idMeal,
                        name: meal.strMeal,
                        price: meal.price || 10.00,
                        image: imgUrl
                    };

                    // Cerchiamo l'oggetto Cart o la funzione add globale
                    if (typeof Cart !== 'undefined' && typeof Cart.add === 'function') {
                        Cart.add(productToCart);
                        feedbackAdd();
                    } else if (typeof add === 'function') {
                        add(productToCart);
                        feedbackAdd();
                    } else {
                        console.error("Funzione di aggiunta carrello non trovata. Verifica cart.js");
                    }

                    function feedbackAdd() {
                        const originalText = addBtn.innerHTML;
                        addBtn.innerHTML = "Preso!";
                        addBtn.style.background = "#2ecc71";
                        setTimeout(() => {
                            addBtn.innerHTML = originalText;
                            addBtn.style.background = "";
                        }, 1500);
                    }
                };

                const catTag = document.createElement('div');
                catTag.style.marginBottom = "5px";
                catTag.innerHTML = `<span style="font-size:0.7rem; background:#eee; padding:2px 6px; border-radius:8px; color:#666;">${meal.strCategory}</span>`;

                const title = document.createElement('h3');
                title.style.cssText = "font-size:1.1rem; margin:0 0 10px 0; color:#2d3436;";
                title.textContent = meal.strMeal;

                const ingr = document.createElement('p');
                ingr.style.cssText = "font-size:0.85rem; color:#666; margin: 0;";
                ingr.textContent = `Ingr: ${ingredientsList}`;

                const findBtn = document.createElement('button');
                findBtn.className = 'btn-primary btn-find-bottom';
                findBtn.innerHTML = 'Trova Ristoranti üìç';
                findBtn.onclick = (e) => {
                    e.stopPropagation();
                    window.location.href = `SearchRestaurants.html?piatto=${encodeURIComponent(meal.strMeal)}`;
                };

                // Append nell'ordine richiesto (Aggiungi -> Categoria -> Nome -> Ingr -> Trova Ristoranti)
                mealInfo.appendChild(addBtn);
                mealInfo.appendChild(catTag);
                mealInfo.appendChild(title);
                mealInfo.appendChild(ingr);
                mealInfo.appendChild(findBtn);
            }

            div.innerHTML = `<img src="${imgUrl}" alt="${meal.strMeal}" style="width:100%; height:180px; object-fit:cover; border-radius:12px;">`;
            div.appendChild(mealInfo);

            return div;
        }
    </script>
</body>
</html>