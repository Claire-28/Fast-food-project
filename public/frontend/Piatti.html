<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LemonLime - Catalogo Piatti</title>

    <link rel="stylesheet" href="css/Header.css">
    <link rel="stylesheet" href="css/mainStyle.css">

    <style>
        /* STILE SPECIFICO PER IL FORM SU 2 RIGHE */
        .filter-bar {
            display: grid;
            /* Creiamo una griglia di 6 colonne virtuali per gestire le larghezze miste */
            grid-template-columns: repeat(6, 1fr);
            gap: 20px;
            align-items: end; /* Allinea il bottone in basso con gli input */
        }

            /* Resetta il margine inferiore predefinito dei form-group */
            .filter-bar .form-group {
                margin-bottom: 0;
            }

                /* RIGA 1: I primi due campi occupano 3 colonne su 6 (quindi il 50% l'uno) */
                .filter-bar .form-group:nth-child(1),
                .filter-bar .form-group:nth-child(2) {
                    grid-column: span 3;
                }

                /* RIGA 2: I successivi tre elementi (incluso il bottone) occupano 2 colonne su 6 (quindi il 33% l'uno) */
                .filter-bar .form-group:nth-child(3),
                .filter-bar .form-group:nth-child(4),
                .filter-bar .form-group:nth-child(5) {
                    grid-column: span 2;
                }

        /* RESPONSIVE: Su schermi piccoli (cellulari) torna tutto su una colonna */
        @media (max-width: 768px) {
            .filter-bar {
                grid-template-columns: 1fr;
            }

                .filter-bar .form-group:nth-child(n) {
                    grid-column: span 1;
                }
        }
    </style>
</head>
<body>

    <!-- SEGNAPOSTO HEADER -->
    <div id="header-placeholder"></div>

    <div class="catalog-container">

        <h2 style="text-align:center; color:#2d3436; margin-bottom:10px;">Esplora i Sapori</h2>
        <p style="text-align:center; margin-bottom:30px;">Cerca tra i nostri ingredienti freschi</p>

        <!-- Barra Filtri (Layout Grid gestito dal CSS sopra) -->
        <div class="filter-bar">
            <!-- Riga 1 (50%) -->
            <div class="form-group">
                <label>Cosa cerchi?</label>
                <input type="text" id="searchName" placeholder="Es. Pasta, Pizza...">
            </div>
            <div class="form-group">
                <label>Categoria</label>
                <input type="text" id="searchCategory" placeholder="Es. Dessert">
            </div>

            <!-- Riga 2 (33%) -->
            <div class="form-group">
                <label>Ingrediente</label>
                <input type="text" id="searchIng" placeholder="Es. Basilico">
            </div>
            <div class="form-group">
                <label>Escludi Allergeni</label>
                <input type="text" id="searchAllergen" placeholder="Es. Noci">
            </div>
            <div class="form-group">
                <button class="btn-primary" onclick="loadMeals()" style="height: 52px; margin-top:0;">Cerca</button>
            </div>
        </div>

        <div id="messageBox" class="message-box" style="margin-bottom: 20px; margin-top: 20px;"></div>

        <div id="mealsGrid" class="grid-container" style="margin-top: 30px;">
            <p style="text-align:center; grid-column: 1/-1;">Caricamento catalogo...</p>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="js/api.js"></script>
    <script src="js/HeaderFunctions.js"></script>

    <script>
        let currentUserRole = null;

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            currentUserRole = localStorage.getItem('ruolo');
            loadMeals();
        });

        async function loadMeals() {
            const grid = document.getElementById('mealsGrid');
            const name = document.getElementById('searchName').value;
            const cat = document.getElementById('searchCategory').value;
            const ing = document.getElementById('searchIng').value;
            const alg = document.getElementById('searchAllergen').value;

            const params = new URLSearchParams();
            if (name) params.append('nome', name);
            if (cat) params.append('tipologia', cat);
            if (ing) params.append('ingredienti', ing);
            if (alg) params.append('allergie', alg);

            grid.innerHTML = '<p style="text-align:center; width:100%; grid-column: 1/-1;">Spremendo i limoni... üçã</p>';

            try {
                const meals = await apiRequest(`/meals?${params.toString()}`, 'GET');

                if (meals.length === 0) {
                    grid.innerHTML = '<p style="text-align:center; width:100%; grid-column: 1/-1;">Nessun piatto trovato.</p>';
                    return;
                }

                grid.innerHTML = '';

                meals.forEach(meal => {
                    grid.appendChild(createMealCard(meal));
                });

            } catch (error) {
                grid.innerHTML = `<p style="color:red; text-align:center; grid-column: 1/-1;">Errore: ${error.message}</p>`;
            }
        }

        function createMealCard(meal) {
            const div = document.createElement('div');
            div.className = 'meal-card';

            const imgUrl = meal.strMealThumb || 'https://via.placeholder.com/300x200?text=No+Image';
            const ingredientsList = meal.ingredients ? meal.ingredients.slice(0, 3).join(', ') + '...' : 'N/D';

            let actionHtml = '';

            if (currentUserRole === 'Ristoratore') {
                actionHtml = `
                        <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                            <input type="number" id="price-${meal.idMeal}" value="10.00" min="0" step="0.5" style="padding:8px; margin-bottom:10px;">
                            <button class="btn-primary" onclick="addToMyMenu('${meal.idMeal}', '${meal.strMeal.replace(/'/g, "\\'")}', '${meal.strCategory}')">
                                Aggiungi +
                            </button>
                        </div>
                    `;
            } else {
                actionHtml = `
                         <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                            <button class="btn-primary" style="background:var(--white); color:var(--text-dark);" onclick="alert('Funzione trova ristorante in arrivo!')">
                                Trova Ristorante
                            </button>
                        </div>
                    `;
            }

            div.innerHTML = `
                    <img src="${imgUrl}" alt="${meal.strMeal}" class="meal-img" style="width:100%; border-radius:12px;">
                    <div class="meal-content">
                        <span class="meal-category">${meal.strCategory}</span>
                        <h3 style="font-size:1.2rem; margin:10px 0;">${meal.strMeal}</h3>
                        <p style="font-size:0.9rem; color:#666;">Ingr: ${ingredientsList}</p>
                    </div>
                    ${actionHtml}
                `;

            return div;
        }

        async function addToMyMenu(id, name, category) {
            const price = document.getElementById(`price-${id}`).value;
            const msgBox = document.getElementById('messageBox');
            try {
                await apiRequest('/restaurant/add-dish', 'POST', { mealId: id, name, category, price });
                msgBox.textContent = `Piatto aggiunto con successo! üçã`;
                msgBox.className = 'message-box success';
                msgBox.style.display = 'block';
                setTimeout(() => { msgBox.style.display = 'none'; }, 3000);
            } catch (error) {
                msgBox.textContent = error.message;
                msgBox.className = 'message-box error';
                msgBox.style.display = 'block';
            }
        }
    </script>
</body>
</html>