<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - LemonLime</title>
    <link rel="stylesheet" href="css/Header.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background: #faf9d2;
            padding-top: 100px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .cart-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .cart-img {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            object-fit: cover;
            margin-right: 20px;
        }

        .cart-info {
            flex-grow: 1;
        }

        .btn-remove {
            color: red;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1.2rem;
        }

        .total-box {
            text-align: right;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 20px 0;
        }

        .btn-confirm {
            width: 100%;
            padding: 15px;
            background: #7ed991;
            color: white;
            border: none;
            font-size: 1.2rem;
            border-radius: 10px;
            cursor: pointer;
        }

            .btn-confirm:hover {
                background: #6bc97e;
            }
    </style>
</head>
<body>
    <div id="header-placeholder"></div>

    <div class="container">
        <h1>Il tuo Carrello ðŸ›’</h1>
        <div id="cart-items"></div>

        <div class="total-box">
            Totale: â‚¬ <span id="cart-total">0.00</span>
        </div>

        <button class="btn-confirm" onclick="submitOrder()">Conferma Ordine e Paga</button>
    </div>

    <script src="js/api.js"></script>
    <script src="js/HeaderFunctions.js"></script>
    <script src="js/cart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', loadCart);

        function loadCart() {
            const items = Cart.getItems();
            const container = document.getElementById('cart-items');
            container.innerHTML = '';

            if(items.length === 0) {
                container.innerHTML = '<p>Il carrello Ã¨ vuoto.</p>';
                return;
            }

            items.forEach(item => {
                container.innerHTML += `
                    <div class="cart-card">
                        <img src="${item.image}" class="cart-img" onerror="this.src='https://via.placeholder.com/80'">
                        <div class="cart-info">
                            <h3>${item.name}</h3>
                            <p>QuantitÃ : ${item.quantity} x â‚¬${item.price.toFixed(2)}</p>
                        </div>
                        <button class="btn-remove" onclick="removeItem('${item.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            });

            document.getElementById('cart-total').innerText = Cart.total().toFixed(2);
        }

        function removeItem(id) {
            Cart.remove(id);
            loadCart();
        }

        async function submitOrder() {
            if (!API.isLoggedIn()) {
                alert("Devi effettuare il login per ordinare!");
                window.location.href = 'LogIn.html';
                return;
            }

            const items = Cart.getItems();
            if (items.length === 0) return alert("Carrello vuoto!");

            // Prepariamo i dati ESATTAMENTE come li vuole il controller backend
            const orderData = {
                ristoranteId: items[0].restaurantId || "65a1234b56789c0123d4567e", // Recuperalo dinamicamente dal carrello o dalla sessione
                carrello: items.map(item => ({
                    mealId: item.id,
                    quantita: item.quantity
                })),
                indirizzoConsegna: "Via Roma 1, Milano", // Prendi questo valore da un input nel form
                tipoConsegna: "Consegna a domicilio", // O "Ritiro"
                paymentMethod: "Carta di Credito"
            };

            try {
                // EFFETTUA LA CHIAMATA REALE
                const res = await API.createOrder(orderData);

                if (res.success || res.message.includes("successo")) {
                    alert("Ordine inviato con successo!");
                    Cart.clear();
                    window.location.href = 'ClientOrders.html';
                } else {
                    alert("Errore dal server: " + res.error);
                }
            } catch (error) {
                alert("Errore nell'invio ordine: " + error.message);
            }
        }
    </script>
</body>
</html>